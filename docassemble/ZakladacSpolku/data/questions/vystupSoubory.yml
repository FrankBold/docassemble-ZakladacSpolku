include:
  - t_maily.yml
---
modules:
  - .integrace
---
# Následující části kodu určují jaké šablony se mají přidat k odesílaným přílohám. Jejich pořadí také určuje pořadí, v jakém průvodce doplňuje proměnné.
# Podle obsahu proměnných se pak do DAFileCollection "Soubory" vkládají jednotlivé přílohy k odeslání.
# Kombinace need a sets určuje pořadí.
sets: s_stanovy
code: |
  Soubory.append(stanovy)
  s_stanovy = True
---
need: s_stanovy
sets: s_statutar
code: |
  if hromadne:
    Soubory.append(Spolek.statutar.clen.prohlaseni)
  else:
    for clen in Spolek.statutar.clen:
      Soubory.append(clen.prohlaseni)
  s_statutar = True
---
need: s_statutar
sets: s_kontrolni
code: |
  if not minimalVerze:
    if Spolek.kontrolniKomise.exist:
      if hromadne:
        Soubory.append(Spolek.kontrolniKomise.prohlaseni)
      else:
        for clen in Spolek.kontrolniKomise:
          Soubory.append(clen.prohlaseni)
  s_kontrolni = True
---
need: s_kontrolni
sets: s_rozhodci
code: |
  if not minimalVerze:
    if Spolek.rozhodciKomise.exist:
      if hromadne:
        Soubory.append(Spolek.rozhodciKomise.prohlaseni)
      else:
        for clen in Spolek.rozhodciKomise:
          Soubory.append(clen.prohlaseni)
  s_rozhodci = True
---
need: s_rozhodci
sets: s_souhlas
code: |
  Soubory.append(souhlas)
  s_souhlas = True
---
need: s_souhlas
sets: souboryDone
code: |
  souboryDone = True
---
# Cílová stránka celého průvodce.
id: souboryKeStazeni
sets: vseHotovo
mandatory: True
progress: 100
need:
 - minimalVerze
 - osobniUdaje
 - souboryDone
question: |
  Zde jsou Vaše dokumenty
subquestion: |
  Vše potřebné Vám zašleme na e-mail spolu s informacemi k dalšímu postupu.

  V e-mailu bude též odkaz na kontrolní seznam, na co nezapomenout před odesláním žádosti. Zkontrolujete si, že máte všude správné podpisy, aj.
  % if user_has_privilege('admin'):
  ${ zip_file(Soubory, filename="Podklady_Spolek.zip") }
  % endif
  % if Spolek.zalozeni.typ == 'schuze':
  % endif
fields:
  - Váš e-mail: email
    datatype: email
  - note: |
      <button id="run" class="btn btn-primary">Odeslat na e-mail</button>

      <span id="resultsArea"></span>
# Skript starající se o odeslání e-mailu.
script: |
  <script>
    $("#run").click(function(){
      $("#resultsArea").html("<div class='spinner-border' role='status'></div> Odesílám...")
      action_call('odeslatEmail', {email: val('email')}, function(data){
        if (data.status) {
          $("#resultsArea").html("E-mail bych úspěšně odeslán.")
        } else {
          $("#resultsArea").html("Něco se pokazilo.")
        }
      });
     return false;
    });
  </script>
continue buttton field: vseHotovo
---
# Doplnit poslední stránku s informacemi co dál, FR výzvou, atd.
# mandatory: True
id: final_screen
need: vseHotovo
question: |
  Úspěšně odesláno!
---
# Odeslání e-mailu s dokumenty. Zároveň přidání kontaktu k mailing listu v rámci Ecomailu.
event: odeslatEmail
code: |
  emailOdeslan = send_email(to=action_argument('email'), template=potvrzeniDok, attachments=Soubory)
  ecomail = addEcomail(action_argument('email'))
  json_response(dict(status=emailOdeslan))
---
# Vytvoření odkazu na checklist s předáním potřebných údajů tak, aby si průvodce v rámci checklistu mohl stáhnout potřebné proměnné z tohoto průvodce.
code: |
  idSesn = user_info().session
  idFile = user_info().filename
  odkazChecklist = "https://da.frankbold.org/interview?i=docassemble.playground1ZakladacSpolku:checklist.yml&idSesn=" + idSesn +"&idFile=" + idFile
---
attachment:
  name: Stanovy spolku
  filename: Stanovy_spolku
  variable name: stanovy
  docx template file: Stanovy.docx
  valid formats:
    - docx
---
# Pokud má být společný dokument pro všechny členy orgánu. Je předán celý PartyList
generic object: PartyList
attachment:
  name: Prohlášení osob zapisovaných do rejstříku
  filename: Prohlášení_${ x.label }
  variable name: x.prohlaseni
  docx template file: Prohlaseni.docx
  valid formats:
    - docx
---
# Pokud má každá člen orgánu mít svůj dokument. Je předáván každý jednotlivý Individual.
generic object: Individual
attachment:
  name: Prohlášení osob zapisovaných do rejstříku
  filename: Prohlášení_${ x.label }
  variable name: x.prohlaseni
  docx template file: Prohlaseni.docx
  valid formats:
    - docx
---
attachment:
  name: Souhlas s umístěním sídla spolku
  filename: Souhlas vlastníka
  variable name: souhlas
  docx template file: Souhlas.docx
  valid formats:
    - docx
---
attachment:
  name: Zápis ze ustavující schůze
  filename: Schůze zápis
  variable name: schuze
  docx template file: Schuze.docx
  valid formats:
    - docx
